(function($) {

    $.spapp = function(options) {

        // Set config and routes
        var config, routes = {};

        config = $.extend({
            defaultView: $("main#spapp > section:last-child").attr("id"),
            templateDir: 'tpl/',
            pageNotFound: false
        }, options);

        // Initialize routes based on section elements
        $("main#spapp > section").each(function(index, element) {
            var elm = $(this);
            routes[elm.attr("id")] = {
                view: elm.attr("id"),
                load: elm.data("load"),
                onCreate: function() {},
                onReady: function() {}
            };
        });

        // Function to add or update routes dynamically
        this.route = function(options) {
            if (routes[options.view]) {
                $.extend(routes[options.view], options);
            }
        };

        // Handle hash change and navigate to the correct route
        var routeChange = function() {
            var id = location.hash.slice(1);
            var route = routes[id];
            var elm = $("#" + id);

            if (!elm || !route) {
                if (config.pageNotFound) {
                    window.location.hash = config.pageNotFound;
                    return;
                }
                console.warn(`⚠️ Route "${id}" not defined.`);
                return;
            }

            if (elm.hasClass("spapp-created")) {
                route.onReady();
            } else {
                elm.addClass("spapp-created");

                if (!route.load) {
                    route.onCreate();
                    route.onReady();
                } else {
                    elm.load(config.templateDir + route.load, function() {
                        route.onCreate();
                        route.onReady();
                    });
                }
            }
        };

        // Initialize and listen for hash changes
        this.run = function() {
            window.addEventListener('hashchange', function() {
                routeChange();
            });

            if (!window.location.hash) {
                window.location.hash = config.defaultView;
            } else {
                routeChange();
            }
        };

        return this;
    };

}(jQuery));